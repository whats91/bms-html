<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./config.js"></script>
  <script src="./api.js"></script>
  <script src="./auth.js"></script>
  <script>
    function loadUserCard() {
      var localUser = getUser();
      var view = document.getElementById("user-view");
      var status = document.getElementById("status-get");

      status.innerHTML = "";
      
      BMS.getCustomer(localUser.uid)
        .then(function(data) {
          var user = data.user;
          // Update local cache in case server has fresher values
          saveUser(user);

          view.innerHTML = `
            <div class="grid-2">
              <div class="card">
                <h2 style="margin-top:0">Profile</h2>
                <div class="note">Basic information</div>
                <div style="margin-top:12px; display:grid; gap:8px;">
                  <div><strong>Name:</strong> ${user.name || "-"}</div>
                  <div><strong>Username:</strong> ${user.username || "-"}</div>
                  <div><strong>Email:</strong> ${user.email || "-"}</div>
                  <div><strong>Phone:</strong> ${user.phone || "-"}</div>
                  <div><strong>UID:</strong> <code>${user.uid}</code></div>
                  <div><strong>Status:</strong> ${user.status === 1 ? "Active" : "Inactive"}</div>
                </div>
              </div>
              <div class="card">
                <h2 style="margin-top:0">Update Account</h2>
                <div class="note">Edit your details below and save.</div>

                <form id="form-update" class="form" style="margin-top:12px;">
                  <div class="row">
                    <div>
                      <label>Username</label>
                      <input class="input" name="username" value="${user.username || ""}" required />
                    </div>
                    <div>
                      <label>Full name</label>
                      <input class="input" name="name" value="${user.name || ""}" required />
                    </div>
                  </div>
                  <div class="row">
                    <div>
                      <label>Phone</label>
                      <input class="input" name="phone" value="${user.phone || ""}" required />
                    </div>
                    <div>
                      <label>Email</label>
                      <input class="input" type="email" name="email" value="${user.email || ""}" required />
                    </div>
                  </div>
                  <div>
                    <label>New password (optional)</label>
                    <input class="input" type="password" name="password" placeholder="Leave blank to keep current" />
                  </div>

                  <div id="status-update"></div>
                  <button class="btn" type="submit">Save changes</button>
                </form>
              </div>
            </div>
          `;

          // Bind update form
          document.getElementById("form-update").addEventListener("submit", function(e) {
            e.preventDefault();
            var formStatus = document.getElementById("status-update");
            formStatus.innerHTML = "";

            var fd = new FormData(e.currentTarget);
            var payload = {
              customer_uid: user.uid,
              username: (fd.get("username") || "").toString().trim(),
              name: (fd.get("name") || "").toString().trim(),
              phone: (fd.get("phone") || "").toString().trim(),
              email: (fd.get("email") || "").toString().trim(),
            };
            var pwd = (fd.get("password") || "").toString();
            if (pwd) payload.password = pwd;

            var submitBtn = e.currentTarget.querySelector("button[type=submit]");
            submitBtn.disabled = true;
            
            BMS.updateCustomer(payload)
              .then(function(res) {
                saveUser(res.user);
                formStatus.innerHTML = '<div class="alert success">Saved!</div>';
                loadUserCard(); // re-render with latest data
              })
              .catch(function(err) {
                formStatus.innerHTML = '<div class="alert error">' + (err.message || "Update failed") + '</div>';
              })
              .finally(function() {
                submitBtn.disabled = false;
              });
          });
        })
        .catch(function(err) {
          status.innerHTML = '<div class="alert error">' + (err.message || "Could not load profile") + '</div>';
        });
    }

    window.addEventListener("DOMContentLoaded", function() {
      requireAuth();
      
      // Sidebar actions
      document.getElementById("btn-logout").addEventListener("click", function(e) {
        e.preventDefault();
        logout();
      });
      
      loadUserCard();
    });
  </script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">BotMasterSender</div>
      <nav class="menu">
        <a href="#" class="active">Dashboard</a>
        <a href="#account">Account</a>
      </nav>
      <div style="margin-top:auto;"></div>
      <button id="btn-logout" class="btn outline" style="width:100%; margin-top:16px;">Log out</button>
    </aside>

    <main class="content">
      <div class="card wide">
        <h1 style="margin:0">Dashboard</h1>
        <p class="lead">Your profile and account settings.</p>
        <div id="status-get"></div>
      </div>

      <section id="user-view" style="margin-top:16px;"></section>
    </main>
  </div>
</body>
</html>